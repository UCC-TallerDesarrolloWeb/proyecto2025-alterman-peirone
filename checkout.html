<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finalizar Compra - CrewLab</title>

  <!-- Metas del proyecto -->
  <meta name="author" content="Ivo Alterman y German Peirone" />
  <meta name="description" content="Finalizá tu compra en CrewLab: confirmá tus datos y elegí el método de envío." />
  <meta name="keywords" content="CrewLab, checkout, finalizar compra, envío, dirección, datos personales" />

  <!-- Favicon -->
  <link rel="icon" href="FAVICON/favicon-32x32.png" type="image/png" />

  <!-- CSS principal del sitio -->
  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* Utilitario: contenido accesible no visible (no afecta el diseño) */
    .sr-only{
      position:absolute!important;width:1px!important;height:1px!important;
      padding:0!important;margin:-1px!important;overflow:hidden!important;
      clip:rect(0,0,0,0)!important;white-space:nowrap!important;border:0!important;
    }

    /* Estilos específicos del formulario */
    .checkout-container {
      max-width: 700px;
      margin: 40px auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      text-align: left;
    }

    .checkout-container h1,
    .checkout-container h2 {
      margin-bottom: 15px;
      text-align: left;
    }

    .resumen-carrito {
      margin-bottom: 30px;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 16px;
      background: #fafafa;
    }

    .resumen-carrito ul {
      list-style: none;
      padding: 0;
      margin: 0 0 10px;
    }

    .resumen-carrito li {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px dashed #e6e6e6;
      font-size: 15px;
    }
    .resumen-carrito li:last-child { border-bottom: none; }

    #checkout-total {
      text-align: right;
      font-weight: bold;
      margin-top: 10px;
    }

    .checkout-container label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
      text-align: left;
    }

    /* No aplicar width:100% a radios/checkbox */
    .checkout-container input:not([type="radio"]):not([type="checkbox"]),
    .checkout-container select,
    .checkout-container textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
      background: #fff;
      box-sizing: border-box;
    }

    .checkout-container textarea { resize: vertical; }

    .checkout-container button {
      margin-top: 20px;
      width: 100%;
      padding: 12px;
      background: green;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
    }
    .checkout-container button:hover { background: darkgreen; }

    /* Opciones de envío (fieldset reseteado para que no cambie tu UI) */
    fieldset.metodo-envio {
      border: 0;
      padding: 0;
      margin: 15px 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    .metodo-envio label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: normal;
      width: auto;
    }
    .metodo-envio input[type="radio"] {
      width: auto;
      height: auto;
      margin: 0;
      flex-shrink: 0;
    }

    /* Mensajes / estados de error */
    .alerta{
      background:#fff5f5; color:#b00020; border:1px solid #ffcdd2;
      padding:10px 12px; border-radius:8px; margin:0 0 16px 0; display:none;
    }
    .input-error{
      border-color: #e53935 !important; outline: 0;
    }
    .error-msg{
      color:#e53935; font-size:13px; margin-top:6px;
    }
  </style>
</head>
<body>
  <header>
    <a href="index.html" class="logo" aria-label="Volver al inicio">CrewLab</a>
  </header>

  <main>
    <div class="checkout-container">
      <h1>Finalizar compra</h1>
      <div id="alerta" class="alerta" role="alert" aria-live="polite"></div>

      <!-- Resumen del carrito -->
      <div class="resumen-carrito" aria-labelledby="resumen-title">
        <h2 id="resumen-title">Resumen de tu compra</h2>
        <ul id="checkout-lista"></ul>
        <p id="checkout-total">Total: $0</p>
      </div>

      <form id="checkout-form" action="#" method="POST" novalidate>
        <!-- Método de envío -->
        <h2>Método de envío</h2>
        <fieldset class="metodo-envio" aria-describedby="ayuda-envio">
          <legend class="sr-only">Elegí el método de envío</legend>
          <label><input type="radio" name="envio" value="domicilio" checked> Envío a domicilio</label>
          <label><input type="radio" name="envio" value="express"> Envío Express (Solo Cba)</label>
          <label><input type="radio" name="envio" value="local"> Retiro por el local</label>
        </fieldset>
        <small id="ayuda-envio" class="sr-only">Seleccioná una opción.</small>

        <!-- Datos personales -->
        <h2>Datos del comprador</h2>
        <label for="nombre">Nombre:</label>
        <input id="nombre" name="nombre" type="text" required placeholder="Ej.: Juan" autocomplete="given-name" />

        <label for="apellido">Apellido:</label>
        <input id="apellido" name="apellido" type="text" required placeholder="Ej.: Pérez" autocomplete="family-name" />

        <label for="dni">DNI:</label>
        <input id="dni" name="dni" type="text" required placeholder="Solo números (7 a 10 dígitos)" inputmode="numeric" pattern="\d{7,10}" />

        <label for="genero">Género:</label>
        <select id="genero" name="genero" required>
          <option value="" selected disabled>Seleccioná…</option>
          <option value="masculino">Masculino</option>
          <option value="femenino">Femenino</option>
          <option value="otro">Otro</option>
        </select>

        <!-- Dirección -->
        <h2>Dirección de entrega</h2>
        <label for="calle">Calle:</label>
        <input id="calle" name="calle" type="text" required placeholder="Ej.: San Martín" autocomplete="address-line1" />

        <label for="numero">Número:</label>
        <input id="numero" name="numero" type="number" required placeholder="Ej.: 1234" min="1" />

        <label for="piso">Piso:</label>
        <input id="piso" name="piso" type="text" placeholder="Ej.: 3" autocomplete="address-line2" />

        <label for="departamento">Departamento:</label>
        <input id="departamento" name="departamento" type="text" placeholder="Ej.: B" autocomplete="address-line2" />

        <label for="cp">Código Postal:</label>
        <input id="cp" name="cp" type="text" required placeholder="Ej.: 5000" inputmode="numeric" pattern="\d{4,10}" autocomplete="postal-code" />

        <label for="ciudad">Ciudad:</label>
        <input id="ciudad" name="ciudad" type="text" required placeholder="Ej.: Córdoba" autocomplete="address-level2" />

        <label for="provincia">Provincia:</label>
        <select id="provincia" name="provincia" required autocomplete="address-level1">
          <option value="" selected disabled>Seleccioná…</option>
          <option value="Buenos Aires">Buenos Aires</option>
          <option value="Córdoba">Córdoba</option>
          <option value="Santa Fe">Santa Fe</option>
          <option value="Mendoza">Mendoza</option>
          <option value="Entre Ríos">Entre Ríos</option>
        </select>

        <label for="observaciones">Observaciones:</label>
        <textarea id="observaciones" name="observaciones" placeholder="Indicaciones para el envío, horarios, referencia, etc."></textarea>

        <!-- Botón de confirmación -->
        <button type="submit">Confirmar compra</button>
      </form>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 CrewLab - Todos los derechos reservados</p>
  </footer>

  <!-- Script para resumen + validación -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ===== Carrito =====
      const STORAGE_KEY = 'crewlab_carrito';
      const getCart = () => JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

      const lista = document.getElementById("checkout-lista");
      const totalTexto = document.getElementById("checkout-total");
      const alerta = document.getElementById("alerta");
      const form = document.getElementById("checkout-form");

      function renderCartSummary(){
        const carrito = getCart();
        lista.innerHTML = "";
        let total = 0;

        if (carrito.length === 0) {
          alerta.style.display = "block";
          alerta.textContent = "Tu carrito está vacío. Agregá productos antes de confirmar.";
        } else {
          alerta.style.display = "none";
        }

        carrito.forEach(item => {
          const subtotal = item.precio * item.cantidad;
          total += subtotal;
          const li = document.createElement("li");
          li.innerHTML = `
            <span>${item.nombre} (x${item.cantidad})</span>
            <strong>$${subtotal.toLocaleString("es-AR")}</strong>
          `;
          lista.appendChild(li);
        });

        totalTexto.textContent = "Total: $" + total.toLocaleString("es-AR");
      }
      renderCartSummary();

      // ===== Validación =====
      function removeError(input){
        input.classList.remove("input-error");
        input.removeAttribute("aria-invalid");
        const next = input.nextElementSibling;
        if (next && next.classList.contains("error-msg")) {
          if (input.getAttribute("aria-describedby") === next.id) {
            input.removeAttribute("aria-describedby");
          }
          next.remove();
        }
      }

      let errIdCounter = 0;
      function showError(input, message){
        removeError(input); // limpiar si ya había uno
        input.classList.add("input-error");
        input.setAttribute("aria-invalid","true");
        const error = document.createElement("div");
        error.className = "error-msg";
        error.id = `err-${input.id || 'fld'}-${++errIdCounter}`;
        error.textContent = message;
        input.setAttribute("aria-describedby", error.id);
        input.insertAdjacentElement("afterend", error);
      }

      function validateForm(){
        let ok = true;
        const carritoVacio = getCart().length === 0;

        // Limpiar errores previos
        form.querySelectorAll(".input-error").forEach(el => removeError(el));
        form.querySelectorAll(".error-msg").forEach(el => el.remove());

        // Bloquear si el carrito está vacío
        if (carritoVacio) {
          alerta.style.display = "block";
          alerta.textContent = "Tu carrito está vacío. Agregá productos antes de confirmar.";
          ok = false;
        } else {
          alerta.style.display = "none";
        }

        // Campos requeridos
        const requeridos = ["nombre","apellido","dni","genero","calle","numero","cp","ciudad","provincia"];
        requeridos.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          const val = (el.value || "").toString().trim();

          if ((el.tagName === "SELECT" && (!val || val === "")) || val === "") {
            showError(el, "Este campo es obligatorio.");
            ok = false;
          } else {
            if (id === "dni" && !/^\d{7,10}$/.test(val)) {
              showError(el, "Ingresá un DNI válido (solo números, 7 a 10 dígitos).");
              ok = false;
            }
            if (id === "numero" && Number(val) <= 0) {
              showError(el, "Ingresá un número válido.");
              ok = false;
            }
            if (id === "cp" && !/^\d{4,10}$/.test(val)) {
              showError(el, "Ingresá un CP válido (solo números, 4 a 10 dígitos).");
              ok = false;
            }
          }
        });

        const firstError = form.querySelector(".input-error");
        if (!ok && firstError) firstError.scrollIntoView({ behavior:"smooth", block:"center" });

        return ok;
      }

      // Enviar
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (validateForm()) {
          alert("¡Gracias por tu compra! Te enviaremos la confirmación por email.");
          // Si querés limpiar el carrito y redirigir, descomentá:
          // localStorage.removeItem(STORAGE_KEY);
          // window.location.href = "index.html";
        }
      });

      // Remover error mientras el usuario escribe/selecciona
      form.addEventListener("input", (e) => {
        const el = e.target;
        if (!el.id) return;
        const val = (el.value || "").toString().trim();

        if (el.id === "dni") {
          if (/^\d{7,10}$/.test(val)) removeError(el);
          return;
        }
        if (el.id === "numero") {
          if (val !== "" && Number(val) > 0) removeError(el);
          return;
        }
        if (el.id === "cp") {
          if (/^\d{4,10}$/.test(val)) removeError(el);
          return;
        }
        if (val !== "") removeError(el);
      });

      form.addEventListener("change", (e) => {
        const el = e.target;
        if (el.matches('select, input[type="radio"]') && (el.value || "").toString().trim() !== "") {
          removeError(el);
        }
      });
    });
  </script>
</body>
</html>
